#pragma once
#ifndef _CODE128_H
#define _CODE128_H
#include "BarCode.h"

namespace barcode {
	/**
	 * @class Code128
	 * @brief Code 128 条形码生成类（支持 Set A/B/C）
	 *
	 * 特性：
	 *  - 支持 Set A/B/C 自动切换
	 *  - 自动计算校验和
	 *  - 支持可选显示可读标签 (_showLabels)
	 *  - 基于元素数组生成条码，可与 OpenCV 绘图结合
	 */
	class Code128 final : public CodeBarcode {
		using CodeBarcode::CodeBarcode;

	protected:
		/**
		 * @brief 校验字符是否可用于 Code128（Set B 基线）
		 * @param c 待验证字符
		 * @return true 可用，false 不可用
		 */
		bool isValidChar(char c) const override;

		/**
		 * @brief 准备内部编码数据（Set B baseline）
		 * @param userData 用户输入字符串
		 * @return 内部编码数据（可能与输入相同）
		 */
		std::string prepareEncodedData(
			const std::string& userData) const override;

		/**
		* @brief 计算校验符（返回 symbol value）
		* @param encoded 内部编码数据
		* @return 校验码 symbol value
		*/
		char calculateCheckDigit(const std::string& encoded) override;

		/**
		 * @brief 构建条码元素数组
		 * @param data 内部编码数据
		 */
		void buildElements(const std::string& data) override;

		/**
		* @brief 在条码下方绘制可读字符
		*/
		void addLabels() override;

	private:
		// =========================
		// 内部类型定义
		// =========================
		enum class Action { OUTPUT, SWITCH_A, SWITCH_B, SWITCH_C };
		enum class CodeSet { A, B, C };

		// =========================
		// 常量定义
		// =========================
		static  const std::array<std::string, 107> CODE128_PATTERNS;	///< 0~106 模式表
		//= {
		//	/*  0 */ "212222",
		//	/*  1 */ "222122",
		//	/*  2 */ "222221",
		//	/*  3 */ "121223",
		//	/*  4 */ "121322",
		//	/*  5 */ "131222",
		//	/*  6 */ "122213",
		//	/*  7 */ "122312",
		//	/*  8 */ "132212",
		//	/*  9 */ "221213",
		//	/* 10 */ "221312",
		//	/* 11 */ "231212",
		//	/* 12 */ "112232",
		//	/* 13 */ "122132",
		//	/* 14 */ "122231",
		//	/* 15 */ "113222",
		//	/* 16 */ "123122",
		//	/* 17 */ "123221",
		//	/* 18 */ "223211",
		//	/* 19 */ "221132",
		//	/* 20 */ "221231",
		//	/* 21 */ "213212",
		//	/* 22 */ "223112",
		//	/* 23 */ "312131",
		//	/* 24 */ "311222",
		//	/* 25 */ "321122",
		//	/* 26 */ "321221",
		//	/* 27 */ "312212",
		//	/* 28 */ "322112",
		//	/* 29 */ "322211",
		//	/* 30 */ "212123",
		//	/* 31 */ "212321",
		//	/* 32 */ "232121",
		//	/* 33 */ "111323",
		//	/* 34 */ "131123",
		//	/* 35 */ "131321",
		//	/* 36 */ "112313",
		//	/* 37 */ "132113",
		//	/* 38 */ "132311",
		//	/* 39 */ "211313",
		//	/* 40 */ "231113",
		//	/* 41 */ "231311",
		//	/* 42 */ "112133",
		//	/* 43 */ "112331",
		//	/* 44 */ "132131",
		//	/* 45 */ "113123",
		//	/* 46 */ "113321",
		//	/* 47 */ "133121",
		//	/* 48 */ "313121",
		//	/* 49 */ "211331",
		//	/* 50 */ "231131",
		//	/* 51 */ "213113",
		//	/* 52 */ "213311",
		//	/* 53 */ "213131",
		//	/* 54 */ "311123",
		//	/* 55 */ "311321",
		//	/* 56 */ "331121",
		//	/* 57 */ "312113",
		//	/* 58 */ "312311",
		//	/* 59 */ "332111",
		//	/* 60 */ "314111",
		//	/* 61 */ "221411",
		//	/* 62 */ "431111",
		//	/* 63 */ "111224",
		//	/* 64 */ "111422",
		//	/* 65 */ "121124",
		//	/* 66 */ "121421",
		//	/* 67 */ "141122",
		//	/* 68 */ "141221",
		//	/* 69 */ "112214",
		//	/* 70 */ "112412",
		//	/* 71 */ "122114",
		//	/* 72 */ "122411",
		//	/* 73 */ "142112",
		//	/* 74 */ "142211",
		//	/* 75 */ "241211",
		//	/* 76 */ "221114",
		//	/* 77 */ "413111",
		//	/* 78 */ "241112",
		//	/* 79 */ "134111",
		//	/* 80 */ "111242",
		//	/* 81 */ "121142",
		//	/* 82 */ "121241",
		//	/* 83 */ "114212",
		//	/* 84 */ "124112",
		//	/* 85 */ "124211",
		//	/* 86 */ "411212",
		//	/* 87 */ "421112",
		//	/* 88 */ "421211",
		//	/* 89 */ "212141",
		//	/* 90 */ "214121",
		//	/* 91 */ "412121",
		//	/* 92 */ "111143",
		//	/* 93 */ "111341",
		//	/* 94 */ "131141",
		//	/* 95 */ "114113",
		//	/* 96 */ "114311",
		//	/* 97 */ "411113",
		//	/* 98 */ "411311",
		//	/* 99 */ "113141",
		//	/*100 */ "114131",
		//	/*101 */ "311141",
		//	/*102 */ "411131",
		//	/*103 */ "211412", // Start A
		//	/*104 */ "211214", // Start B
		//	/*105 */ "211232", // Start C
		//	/*106 */ "2331112" // Stop (7 elements)
		//}; 

		static constexpr int START_B = 104;								///< 默认起始符
		static constexpr int STOP = 106;								///< 停止符

		// =========================
		// 内部工具函数
		// =========================

		/**
		* @brief 判断字符是否为控制字符（需用 Set A）
		* @param c 待判断字符
		* @return true 控制字符
		*/
		bool isControlChar(char c) const;

		/**
		* @brief 将 symbol value 转换为条码元素并添加到 elements
		* @param value symbol value（0~106）
		*/
		void appendPattern(int value);

		/**
		 * @brief 将字符转换为 CodeSet 内部 value
		 * @param c 字符
		 * @param set 当前 CodeSet
		 * @return 内部 value
		 */
		int charToValue(char c, CodeSet set) const;

		/**
		 * @brief 判断当前位置是否可切换到 Set C（数字压缩）
		 * @param s 数据字符串
		 * @param pos 当前索引
		 * @return true 可以切换
		 */
		static bool canUseSetC(const std::string& s, size_t pos);
	};
}
#endif
/*
* const std::array<std::string, 107> Code128::CODE128_PATTERNS = {
	"212222","222122","222221","121223","121322","131222","122213","122312",
	"132212","221213","221312","231212","112232","122132","122231","113222",
	"123122","123221","223211","221132","221231","213212","223112","312131",
	"311222","321122","321221","312212","322112","322211","212123","212321",
	"232121","111323","131123","131321","112313","132113","132311","211313",
	"231113","231311","112133","112331","132131","113123","113321","133121",
	"313121","211331","231131","213113","213311","213131","311123","311321",
	"331121","312113","312311","332111","314111","221411","431111","111224",
	"111422","121124","121421","141122","141221","112214","112412","122114",
	"122411","142112","142211","241211","221114","413111","241112","134111",
	"111242","121142","121241","114212","124112","124211","411212","421112",
	"421211","212141","214121","412121","111143","111341","131141","114113",
	"114311","411113","411311","113141","114131","311141","411131","211412",
	"211214","211232","2331112"
};
*/